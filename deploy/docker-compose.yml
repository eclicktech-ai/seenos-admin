# SeenOS Admin Dashboard with API
#
# Usage:
#   cd deploy
#   docker-compose up -d          # Build and start all services
#   docker-compose up --build    # Rebuild and start
#   docker-compose logs -f        # View logs
#   docker-compose down           # Stop services
#
# Access:
#   - Admin UI: http://localhost:3001
#   - API: http://localhost:8002
#
# Note: Create .env.test file in deploy/ directory for API configuration

services:
  # Build service - builds the application
  builder:
    container_name: seenos_admin_builder
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    volumes:
      # Mount dist directory to share built files
      - dist:/app/dist
    command: sh -c "echo 'Build completed, files in /app/dist'"

  # Server service - runs yarn server (vite preview)
  server:
    container_name: seenos_admin_ui
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    ports:
      - "3001:3001"
    volumes:
      # Mount dist directory from builder
      - dist:/app/dist:ro
    working_dir: /app
    command: sh -c "yarn server"
    depends_on:
      - builder
    networks:
      - seenos-test-net
    restart: unless-stopped

  # API service
  seenos-api:
    container_name: seenos_test
    image: seenos-test:1.0.0
    ports:
      - "8002:8000"
    env_file:
      - .env.test
    environment:
      # Core settings (fixed for test env)
      - SEENOS_ENV=test
      - SEENOS_MODE=distributed

      # Service backends
      - SEENOS_CACHE_BACKEND=redis
      - SEENOS_SEARCH_BACKEND=pgvector
      - SEENOS_KB_BACKEND=json

      # Internal service URLs (fixed)
      # Note: redis and postgres services are defined in another docker-compose.yaml
      - SEENOS_REDIS_URL=redis://redis:6379/0
      - SEENOS_POSTGRES_URL=postgresql://seenos:seenosqaz2026@postgres:5432/seenos
    networks:
      - seenos-test-net
    restart: unless-stopped

volumes:
  dist:

networks:
  # seenos-test-net is defined in another docker-compose.yaml
  seenos-test-net:
    external: true

