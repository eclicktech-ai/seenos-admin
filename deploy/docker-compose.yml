# SeenOS Admin Dashboard with API
# Optimized for Physical Nginx Deployment
#
# Architecture:
#   - Builder: Builds frontend and outputs to physical directory
#   - API: Backend service (only accessible via localhost)
#   - Physical Nginx: Serves static files and proxies API requests
#
# Usage:
#   cd deploy
#   docker-compose build builder              # Build frontend
#   docker-compose run --rm builder          # Generate static files
#   docker-compose up -d seenos-test-api    # Start API service
#
# Access:
#   - Admin UI: http://ui.seokit.tech (via Physical Nginx)
#   - API: http://127.0.0.1:8002 (localhost only, proxied by Nginx)
#
# Note: 
#   - Static files are output to /var/www/seenos-admin
#   - Physical Nginx must be configured separately
#   - Create .env.test file in deploy/ directory for API configuration

services:
  # Build service - builds the application and outputs to physical directory
  builder:
    container_name: seenos_admin_builder
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    volumes:
      # Mount to physical machine directory for Nginx to serve
      - /var/www/seenos-admin:/output
    command: sh -c "cp -r /app/dist/* /output/ && chmod -R 755 /output && echo 'Build completed, files in /output'"
    networks:
      - seenos-test-net

  # API service - backend API (accessible externally)
  seenos-test-api:
    container_name: seenos_test_api
    image: seenos-test:1.0.0
    ports:
      # Expose API port for external access
      # Physical Nginx can also proxy requests to this port
      - "8002:8000"
    env_file:
      - .env.test
    environment:
      # Core settings (fixed for test env)
      - SEENOS_ENV=test
      - SEENOS_MODE=distributed

      # Service backends
      - SEENOS_CACHE_BACKEND=redis
      - SEENOS_SEARCH_BACKEND=pgvector
      - SEENOS_KB_BACKEND=json

      # Internal service URLs (fixed)
      # Note: redis and postgres services are defined in another docker-compose.yaml
      - SEENOS_REDIS_URL=redis://redis:6379/0
      - SEENOS_POSTGRES_URL=postgresql://seenos:seenosqaz2026@postgres:5432/seenos
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:8000/health || curl -f http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - seenos-test-net
    restart: unless-stopped

networks:
  # seenos-test-net is defined in another docker-compose.yaml
  # The actual network name may be deploy_seenos-test-net (with project prefix)
  seenos-test-net:
    external: true
    name: deploy_seenos-test-net
